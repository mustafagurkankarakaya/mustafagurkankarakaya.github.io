---
title: "WannaCry Malware Analizi"
date: 2025-02-25 00:00:00 +0800 
categories: [Malware Analysis]
tags: [Malware Analysis]     # TAG names should always be lowercase
---

## WannaCry Malware Analizi

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-1.webp)


WannaCry, Mayıs 2017'de Windows'un SMBv1 protokolündeki EternalBlue güvenlik açığını kullanarak yayılan ve dosyaları şifreleyerek fidye talep eden bir fidye yazılımıdır (ransomware). 150'den fazla ülkeyi etkileyen saldırı, NHS, FedEx ve Renault gibi büyük kuruluşlara zarar vermiştir. Şifrelenen dosyaları açmak için Bitcoin ile ödeme talep eden yazılım, İngiliz güvenlik araştırmacısı Marcus Hutchins tarafından keşfedilen bir kill switch sayesinde durdurulmuştur. Microsoft, saldırıya karşı MS17-010 güvenlik yamasını yayımlayarak açığı kapatmıştır.

**Özet**

WannaCry, art arda çalıştırılan iki bileşenden oluşur ve sistemdeki dosyaları şifreleyerek SMB ve internet üzerinden aynı ağdaki diğer cihazlara yayılır.

Başlangıç dosyası çalıştırıldığında, yönetici ayrıcalıklarını kontrol eder ve belirli bir URL'ye bağlanmaya çalışır. Eğer yönetici erişimi sağlanmışsa ve URL'ye ulaşılamıyorsa, zararlı yazılım sistemdeki tüm dosyaları şifrelemeye devam eder.

Enfeksiyon belirtileri arasında, "Ooops, your important files are encrypted" mesajını içeren bir duvar kağıdı ve aşağıdaki dosyalar bulunmaktadır:

C:\Windows\tasksche.exe
C:\Users%USER%\Desktop@Please_Read_Me@.txt
C:\Users%USER%\Desktop@WanaDecryptor@.exe
C:\Users%USER%\Desktop@WanaDecryptor@.bmp

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-2.png)
![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-3.png)


İlk aşama bileşeni çalıştırıldığında kontrol edilen iki ana kill-switch bulunur:

1.Belirtilen alan adına erişilip erişilemediğini doğrulamak:

“iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com”

2.Yönetici ayrıcalıklarıyla çalıştırılıp çalıştırılmadığını doğrulamak:

Eğer ilk kontrol başarılı olursa, process hiçbir işlem gerçekleştirmeden kapanır. Ancak, bu kontrol başarısız olursa, process “C:\Windows” dizini altında “tasksche.exe” adlı bir dosya oluşturmaya çalışır. Yönetici ayrıcalıkları olmadan çalıştırıldığında, bu işlem başarısız olur. Eğer dosya yönetici ayrıcalıklarıyla çalıştırılırsa ve ilk kontrol başarılı olursa, yine hiçbir işlem gerçekleştirilmez. Ancak, ilk kontrol başarısız olursa, zararlı yazılım beklenen şekilde çalışmaya devam eder.

ANALİZ

IDA pro aracı kullanarak malware'e ait stringleri kontrol edelim.

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-4.png)


hxxp[:]//www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com adresi yüksek olasılıkla WannaCry zararlısının kullandığı komuta kontrol sunucusuna ait. %s paramatresinin olması ise dynamic olarak oluşacak dosya isimlerine işaret etmektedir.

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-5.png)

Imports

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-6.png)
![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-7.png)

API importlarına dayanarak, fidye yazılımının "CreateServiceA" kullanarak bir servis oluşturma, "StartServiceCtrlDispatcherA" ile bir hizmet uygulamasını Hizmet Kontrol Yöneticisi'ne (SCM) bağlama, "send" ve "recv" kullanarak bağlı bir soket üzerinden veri gönderme ve alma, "GetAdaptersInfo" kullanarak bir bilgisayardaki ağ bağdaştırıcıları hakkında bilgi alma, "InternetOpenUrlA" kullanarak bir URL'ye bağlanma ve "MoveFileExA" kullanarak dosya ve dizinleri taşıma veya yeniden adlandırma yeteneklerine sahip olduğu görülmektedir.

Ayrıca, kriptografik işlebler kullanılmaktadır: “CryptAcquireContext” ile bir kriptografik hizmet sağlayıcısına (CSP) erişim sağlanır, “CryptGenKey” ile şifreleme için bir kriptografik anahtar oluşturulur, “CryptEncrypt” ile veriler bu anahtar kullanılarak şifrelenir, “CryptDecrypt” ile şifrelenmiş veriler çözümlenir, “CryptDestroyKey” ile işlem tamamlandığında anahtar imha edilir ve “CryptImportKey” ile gerektiğinde harici bir kaynaktan kriptografik anahtar içe aktarılır.

Capa çıktısına baktığımızda , fidye yazılımı Defense Evasion, Discovery, Persistence, Anti-behavioral and Static Analysis, Command and Control (C2), Cryptography, Data Execution, File System ve Process Handling ile ilgili Mitre aktivitelerine hit ettiğini görmekteyiz.

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-8.png)
![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-9.png)

“wannacry.exe” adlı çalıştırılabilir dosyanın ana fonksiyonuna ait assembly kodunu incelediğimizde, bağlantı için WinINet API'sine ait fonksiyonların kullanıldığını gözlemlemekteyiz. “InternetOpenA” fonksiyonu, “InternetOpenUrlA” tarafından kullanılacak bir bağlantı oluşturur ve bu fonksiyon aşağıdaki URL’yi açmaktadır.:

“xttp://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com”

Daha sonra, önceden oluşturulan bağlantıyı kapatmak için “InternetCloseHandle” fonksiyonunun kullanıldığını görmekteyiz.

![resim]({{ site.url }}{{ site.baseurl }}/assets/img/posts/Wanna-10.png)


